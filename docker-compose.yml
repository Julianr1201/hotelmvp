version: '3.8'

services:
  # ============================================
  # REVERSE PROXY - NGINX Proxy Manager
  # ============================================
  # Proxy inverso para gestionar acceso a todos los servicios
  # Panel de administración: http://IP:81 (admin@example.com / changeme)
  proxy:
    image: jc21/nginx-proxy-manager:latest
    container_name: hotel-proxy
    restart: unless-stopped
    ports:
      - "80:80"      # HTTP
      - "443:443"    # HTTPS
      - "81:81"      # Panel de administración
    volumes:
      - ./services/proxy/data:/data
      - ./services/proxy/letsencrypt:/etc/letsencrypt
    networks:
      - hotel-network
    depends_on:
      # - openwisp  # Comentado temporalmente
      - jellyfin
      - homeassistant

  # ============================================
  # OPENWISP - Controlador WiFi y Portal Cautivo
  # ============================================
  # Sistema de gestión de red WiFi y portal cautivo
  # Acceso: http://wifi.local o http://IP:8000
  # NOTA: OpenWISP requiere configuración adicional (DASHBOARD_DOMAIN y otras variables).
  # Comentado temporalmente. Para habilitarlo, descomenta y configura según documentación oficial.
  # 
  # openwisp:
  #   image: openwisp/openwisp-dashboard:latest
  #   container_name: hotel-openwisp
  #   restart: unless-stopped
  #   ports:
  #     - "8000:8000"
  #   environment:
  #     - DEBUG=0
  #     - DJANGO_SETTINGS_MODULE=openwisp.settings
  #     - DB_ENGINE=django.db.backends.postgresql
  #     - DB_NAME=${OPENWISP_DB_NAME:-openwisp}
  #     - DB_USER=${OPENWISP_DB_USER:-openwisp}
  #     - DB_PASSWORD=${OPENWISP_DB_PASSWORD}
  #     - DB_HOST=openwisp-db
  #     - DB_PORT=5432
  #     - REDIS_HOST=openwisp-redis
  #     - REDIS_PORT=6379
  #     - SECRET_KEY=${OPENWISP_SECRET_KEY}
  #     - TZ=America/Chihuahua
  #     - DASHBOARD_DOMAIN=wifi.local  # REQUERIDO
  #   volumes:
  #     - ./services/openwisp/config:/etc/openwisp
  #     - ./services/openwisp/data:/var/lib/openwisp
  #   networks:
  #     - hotel-network
  #   depends_on:
  #     - openwisp-db
  #     - openwisp-redis

  # Base de datos PostgreSQL para OpenWISP (comentado temporalmente)
  # openwisp-db:
  #   image: postgres:15-alpine
  #   container_name: hotel-openwisp-db
  #   restart: unless-stopped
  #   environment:
  #     - POSTGRES_DB=${OPENWISP_DB_NAME:-openwisp}
  #     - POSTGRES_USER=${OPENWISP_DB_USER:-openwisp}
  #     - POSTGRES_PASSWORD=${OPENWISP_DB_PASSWORD}
  #     - TZ=America/Chihuahua
  #   volumes:
  #     - openwisp-db-data:/var/lib/postgresql/data
  #   networks:
  #     - hotel-network

  # Redis para OpenWISP (comentado temporalmente)
  # openwisp-redis:
  #   image: redis:7-alpine
  #   container_name: hotel-openwisp-redis
  #   restart: unless-stopped
  #   volumes:
  #     - openwisp-redis-data:/data
  #   networks:
  #     - hotel-network

  # ============================================
  # JELLYFIN - Servidor Multimedia
  # ============================================
  # Servidor de medios para streaming a las TVs con Kodi
  # Acceso: http://media.local o http://IP:8096
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: hotel-jellyfin
    restart: unless-stopped
    ports:
      - "8096:8096"
      - "8920:8920"  # HTTPS (opcional)
      - "7359:7359/udp"  # Auto-discovery
      # - "1900:1900/udp"  # DLNA (comentado: puerto en uso)
    environment:
      - TZ=America/Chihuahua
      - JELLYFIN_PublishedServerUrl=${JELLYFIN_PUBLISHED_URL:-http://media.local}
    volumes:
      - ./services/jellyfin/config:/config
      - ${MEDIA_PATH:-./media}:/media:ro  # Solo lectura para seguridad
    networks:
      - hotel-network
    # devices:
    #   - /dev/dri:/dev/dri  # Para aceleración por hardware (opcional, no disponible en WSL2)

  # ============================================
  # HOME ASSISTANT - Control de Climatización
  # ============================================
  # Sistema de automatización para controlar minisplits y otros dispositivos
  # Acceso: http://clima.local o http://IP:8123
  # IMPORTANTE: network_mode: host es necesario para descubrir dispositivos en la red
  homeassistant:
    image: homeassistant/home-assistant:latest
    container_name: hotel-homeassistant
    restart: unless-stopped
    network_mode: host
    environment:
      - TZ=America/Chihuahua
    volumes:
      - ./services/home-assistant/config:/config
    # No se puede usar networks con network_mode: host

  # ============================================
  # REDES
  # ============================================
networks:
  hotel-network:
    driver: bridge
    name: hotel-network

# ============================================
# VOLÚMENES PERSISTENTES
# ============================================
volumes:
  openwisp-db-data:
    name: hotel-openwisp-db-data
  openwisp-redis-data:
    name: hotel-openwisp-redis-data

